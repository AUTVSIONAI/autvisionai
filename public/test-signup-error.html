<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste de Corre√ß√£o - Erro de Cadastro</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e1e2e 0%, #2d2d44 100%);
            color: white;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.1);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        .header h1 {
            color: #61dafb;
            margin-bottom: 10px;
        }
        .step {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            margin: 15px 0;
            border-radius: 10px;
            border-left: 4px solid #61dafb;
        }
        .step h3 {
            color: #61dafb;
            margin-top: 0;
        }
        .code {
            background: #1a1a1a;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            margin: 10px 0;
            overflow-x: auto;
        }
        .warning {
            background: rgba(255, 193, 7, 0.2);
            border-left-color: #ffc107;
            border: 1px solid rgba(255, 193, 7, 0.3);
        }
        .success {
            background: rgba(40, 167, 69, 0.2);
            border-left-color: #28a745;
            border: 1px solid rgba(40, 167, 69, 0.3);
        }
        .error {
            background: rgba(220, 53, 69, 0.2);
            border-left-color: #dc3545;
            border: 1px solid rgba(220, 53, 69, 0.3);
        }
        button {
            background: linear-gradient(135deg, #61dafb 0%, #4fa8d8 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            margin: 5px;
            transition: transform 0.2s;
        }
        button:hover {
            transform: translateY(-2px);
        }
        .results {
            margin-top: 20px;
            min-height: 200px;
            background: #1a1a1a;
            padding: 20px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            white-space: pre-line;
            overflow-y: auto;
            max-height: 400px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîß Teste de Corre√ß√£o</h1>
            <p>Valida√ß√£o da corre√ß√£o do erro "Database error saving new user"</p>
        </div>

        <div class="step success">
            <h3>‚úÖ Problema Identificado</h3>
            <p>O erro "Database error saving new user" indica que:</p>
            <ul>
                <li>Novos usu√°rios n√£o conseguem se cadastrar</li>
                <li>Tabela <code>userprofile</code> tem problemas de estrutura/permiss√µes</li>
                <li>Trigger autom√°tico pode estar falhando</li>
                <li>RLS (Row Level Security) pode estar bloqueando inser√ß√µes</li>
            </ul>
        </div>

        <div class="step warning">
            <h3>‚ö†Ô∏è Passos para Corre√ß√£o</h3>
            <p><strong>1. Execute o SQL de corre√ß√£o no Supabase:</strong></p>
            <div class="code">-- V√° para Supabase ‚Üí SQL Editor
-- Execute o arquivo: FIX_SIGNUP_DATABASE_ERROR.sql</div>
            
            <p><strong>2. Verifique se o trigger foi criado:</strong></p>
            <div class="code">SELECT trigger_name FROM information_schema.triggers 
WHERE event_object_table = 'userprofile';</div>

            <p><strong>3. Teste a inser√ß√£o manual:</strong></p>
            <div class="code">INSERT INTO public.userprofile (id, email, full_name) 
VALUES ('test-123', 'teste@exemplo.com', 'Teste');</div>
        </div>

        <div class="step">
            <h3>üß™ Testes Automatizados</h3>
            <button onclick="runBasicTest()">üîç Teste B√°sico</button>
            <button onclick="runConnectivityTest()">üåê Teste de Conectividade</button>
            <button onclick="runTableTest()">üìä Teste de Tabela</button>
            <button onclick="clearResults()">üßπ Limpar Resultados</button>
        </div>

        <div class="step error">
            <h3>üö® Teste de Cadastro Real</h3>
            <p><strong>Aten√ß√£o:</strong> Este teste criar√° um usu√°rio real no sistema!</p>
            <input type="email" id="testEmail" placeholder="email@teste.com" style="padding: 10px; margin: 5px; background: #2a2a2a; color: white; border: 1px solid #555; border-radius: 5px;">
            <input type="password" id="testPassword" placeholder="senha123" style="padding: 10px; margin: 5px; background: #2a2a2a; color: white; border: 1px solid #555; border-radius: 5px;">
            <input type="text" id="testName" placeholder="Nome Teste" style="padding: 10px; margin: 5px; background: #2a2a2a; color: white; border: 1px solid #555; border-radius: 5px;">
            <br>
            <button onclick="runRealSignUpTest()" style="background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);">‚ö†Ô∏è Teste Real de Cadastro</button>
        </div>

        <div class="results" id="results">
üéØ Resultados dos testes aparecer√£o aqui...

üí° Dicas:
- Execute os testes em ordem
- Se der erro 500/406, execute o SQL de corre√ß√£o
- Verifique o console do navegador para mais detalhes
        </div>
    </div>

    <script>
        let resultsDiv = document.getElementById('results');

        function log(message) {
            resultsDiv.textContent += new Date().toLocaleTimeString() + ' - ' + message + '\n';
            resultsDiv.scrollTop = resultsDiv.scrollHeight;
        }

        function clearResults() {
            resultsDiv.textContent = 'üßπ Resultados limpos.\n\n';
        }

        async function runBasicTest() {
            log('üß™ INICIANDO TESTE B√ÅSICO...');
            
            try {
                // Verificar se est√° na aplica√ß√£o AutVision
                if (window.location.hostname !== 'localhost' && !window.location.hostname.includes('autvision')) {
                    log('‚ö†Ô∏è Execute este teste na aplica√ß√£o AutVision (localhost:3004)');
                    return;
                }

                log('‚úÖ Teste b√°sico conclu√≠do');
                log('üí° Pr√≥ximo passo: Execute o teste de conectividade');

            } catch (error) {
                log('‚ùå Erro no teste b√°sico: ' + error.message);
            }
        }

        async function runConnectivityTest() {
            log('üåê TESTANDO CONECTIVIDADE...');
            
            try {
                // Este teste precisa ser executado no contexto da aplica√ß√£o
                log('üí° Para testar conectividade:');
                log('   1. Abra o console do navegador (F12)');
                log('   2. Execute: window.testSignUpFix()');
                log('   3. Verifique se consegue acessar a tabela userprofile');

            } catch (error) {
                log('‚ùå Erro no teste de conectividade: ' + error.message);
            }
        }

        async function runTableTest() {
            log('üìä TESTANDO ESTRUTURA DA TABELA...');
            
            log('üí° Execute no SQL Editor do Supabase:');
            log('   SELECT column_name, data_type, is_nullable');
            log('   FROM information_schema.columns');
            log('   WHERE table_name = \'userprofile\'');
            log('   ORDER BY ordinal_position;');
            
            log('‚úÖ Verifique se as colunas necess√°rias existem');
        }

        async function runRealSignUpTest() {
            const email = document.getElementById('testEmail').value;
            const password = document.getElementById('testPassword').value;
            const name = document.getElementById('testName').value;

            if (!email || !password) {
                log('‚ùå Preencha email e senha para o teste');
                return;
            }

            log('üö® TESTE REAL DE CADASTRO - CRIAR√Å USU√ÅRIO REAL!');
            log('üìß Email: ' + email);
            log('üîë Senha: ' + '*'.repeat(password.length));
            log('üë§ Nome: ' + (name || 'Usu√°rio Teste'));
            
            log('üí° Para executar este teste:');
            log('   1. V√° para a p√°gina de cadastro da aplica√ß√£o');
            log('   2. Use os dados fornecidos acima');
            log('   3. Verifique se N√ÉO aparece "Database error saving new user"');
            log('   4. Se der erro, execute o SQL de corre√ß√£o no Supabase');
        }

        // Auto-executar teste b√°sico
        setTimeout(() => {
            log('üöÄ P√°gina de teste carregada!');
            log('üí° Execute os testes em ordem para diagnosticar o problema');
        }, 1000);
    </script>
</body>
</html>
